{% extends 'dashboardBase.html' %}
{% load static %}
{% load spiderTemplate_extras %}

{% block title %}EasySpider | 模板配置{% endblock %}

{% block css_extend %}
    <link rel="stylesheet" href="{% static 'spiderTemplate/css/templateSetting.css' %}" />
{% endblock %}

{% block page_title %}参数配置{% endblock %}

{% block page_link %}
    <li class="breadcrumb-item">
        <a href="{% url 'starter' %}">首页</a>
    </li>
    <li class="breadcrumb-item">
        <a href="{% url 'template_first' %}"
            >选择模板</a
        >
    </li>
    <li class="breadcrumb-item">
        <a href="{% url 'template_second' template.site.pk %}">{{ template.site.display_name }}</a>
    </li>
    <li class="breadcrumb-item">
        <a href="{% url 'template_info' template.pk %}">{{ template.display_name }}</a>
    </li>
    <li class="breadcrumb-item active">
        参数配置
    </li>
{% endblock %}

{% block content %}
    <div class="row align-items-center">
        <div
            class="card card-primary col-6"
            id="arguments-card"
        >
            <!-- form start -->
            <form role="form" action="{% if task %}
                                        {% url 'restart_task' task.pk %}
                                      {% else %}
                                        {% url 'create_task' template.pk %}
                                      {% endif %}" method="post" id="setting-form">
                {% csrf_token %}
                <div class="card-body">
                    <h5>基本信息</h5>
                    <div class="form-group">
                        <label for="inputTaskName"
                            >任务名</label
                        >
                        <input
                            type="text"
                            class="form-control"
                            placeholder="请输入任务名"
                            name="inputTaskName"
                            value="{% if task %}{{ task.name }}{% endif %}"
                            required
                        />
                    </div>
                    <h5>配置参数</h5>
                    <div class="form-group arguments-form">
                    {% for param in template.param_set.all %}
                            <label class="{% if forloop.counter0 != 0 %}margin{% endif %}" for="input_{{ param.name }}"
                                >{{ param.display_name }}</label
                            >
                            {% if param.input_label == "input" %}
                                <input
                                    type="{{ param.input_type }}"
                                    id="input_{{ param.name }}"
                                    class="form-control"
                                    placeholder="请输入{{ param.display_name }}"
                                    name="{{ param.name }}"
                                    value="{% if task %}{{ task.args_dict | get_dict_value: param.name }}{% endif %}"
                                    required
                                />
                            {% else %}
                                <textarea
                                    class="form-control"
                                    rows="3"
                                    placeholder="请输入{{ param.display_name }}"
                                    name="{{ param.name }}"
                                    required
                                >{{ task.args_dict | get_dict_value: param.name }}</textarea>
                            {% endif %}
                    {% endfor %}
                    </div>
                    <button
                        type="submit"
                        class="btn btn-primary swalDefaultSuccess"
                    >
                        保存并启动
                    </button>
                </div>
                <!-- /.card-body -->
            </form>
        </div>
        <div class="col-6" id="setting-img-wrapper">
            <img src="{{ template.param_set.all.first.pic }}" />
        </div>
    </div>
{% endblock %}

{% block js_extend %}
    <script>
        // set active for task
        {% if task %}
            recentEditList.find("li a").each(function () {
                let href = $(this).attr("href");
                let taskID = +href.slice(href.lastIndexOf("=") + 1);
                    if(taskID === {{ task.pk }}) {
                        $(this).parents("#recent-edit-list").prev("a").addClass("active");
                        $(this).addClass("active");
                        return false;
                    }
            });
        {% endif %}
    </script>
    <script src="{% static 'spiderTemplate/js/templateSetting.js' %}"></script>
    <script>
        $("#setting-form").submit(function () {
            // 数据验证
            $("input[type=text], textarea").each(function () {
                let value = $(this).val().trim();
                if(value.length === 0) {
                    Toast.fire({
                        icon: "error",
                        title: "&nbsp;" + $(this).attr("placeholder").slice(3) + "不能为空",
                    });
                    return false;
                } else {
                    if($(this).attr("name") === "inputTaskName") {
                        if(value < 3 || value.length > 20) {
                            Toast.fire({
                                icon: "error",
                                title: "&nbsp;任务名长度应在3~20个字符之间",
                            });
                            return false;
                        }
                    }
                }
            });

            $("input[type=number]").each(function () {
                let numberValue = $(this).val();
                if(numberValue < 0 || numberValue > 100) {
                    Toast.fire({
                        icon: "error",
                        title: "&nbsp;错误的值：" + $(this).val() + "，请输入1~99",
                    });
                    return false;
                }
            });

            // 任务状态验证
            {% if task %}
                {% if task.status != 'finished' and task.status != 'canceled' %}
                    Toast.fire({
                        icon: "error",
                        title: "&nbsp;非已完成或已终止的任务无法重新启动",
                    });
                {% endif %}
            {% endif %}

            $.ajax({
                url: $(this).attr("action"),
                type: "POST",
                data: $(this).serialize(),
                cache: false,
                success: function (data) {
                    // console.log(data);
                    if(data["status"] === "SUCCESS") {
                        Toast.fire({
                            icon: "success",
                            title: "&nbsp;任务创建成功，请到我的任务页面查看",
                        });
                        // get top 5 tasks
                        let tasks = data["tasks"];
                        // remove cur tasks
                        recentEditList.empty();
                        // 重新填充 这里将第一个任务置为active即可
                        for(let i = 0; i < tasks.length; i++) {
                            let taskID = tasks[i].id;
                            if(i === 0) {
                                recentEditList.append("<li class=\"nav-item edit-item\">\n" +
                                "<a class=\"nav-link active\" href=\""+ {% url 'template_setting' taskID %} + "?taskID=" + taskID + "\">\n" +
                                "                                            <i\n" +
                                "                                                class=\"far fa-circle nav-icon hidden\"\n" +
                                "                                            ></i>\n" +
                                "                                            <p>\n" +
                                "                                                " + tasks[i].name +"\n" +
                                "                                            </p>\n" +
                                "                                        </a>\n" +
                                "                                    </li>");
                            } else {
                                recentEditList.append("<li class=\"nav-item edit-item\">\n" +
                                "<a class=\"nav-link\" href=\""+ {% url 'template_setting' taskID %} + "?taskID=" + taskID + "\">\n" +
                                "                                            <i\n" +
                                "                                                class=\"far fa-circle nav-icon hidden\"\n" +
                                "                                            ></i>\n" +
                                "                                            <p>\n" +
                                "                                                " + tasks[i].name +"\n" +
                                "                                            </p>\n" +
                                "                                        </a>\n" +
                                "                                    </li>");
                            }
                         }
                    } else {
                        Toast.fire({
                            icon: "error",
                            title: "&nbsp;" + data["message"],
                        });
                    }
                },
                error: function (xhr) {
                    console.log(xhr);
                }
            });
            return false;
        });
    </script>
{% endblock %}
