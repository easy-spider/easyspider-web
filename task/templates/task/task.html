{% extends 'dashboardBase.html' %}
{% load static %}

{% block css_extend %}
    <!-- Custom css -->
    <link rel="stylesheet" href="{% static 'task/css/task.css' %}" />
    <!-- DataTables -->
    <link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.datatables.net/v/bs4/dt-1.10.20/cr-1.5.2/r-2.2.3/datatables.min.css"
    />
    <!-- DataTable Checkbox -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/jquery-datatables-checkboxes@1.2.11/css/dataTables.checkboxes.css"
    />
{% endblock %}

{% block nav_task_active %}active{% endblock %}

{% block page_title %}我的任务{% endblock %}

{% block page_link %}
    <li class="breadcrumb-item">
        <a href="{% url 'starter' %}">首页</a>
    </li>
    <li class="breadcrumb-item active">
        我的任务
    </li>
    <li class="breadcrumb-item"></li>
{% endblock %}

{% block content %}
    <div class="row">
      <div class="card m-auto" id="task-card">
        <div class="card-body">
            <form action="{% url 'my_task' %}" id="task-form" method="POST">
                {% csrf_token %}
                <table
                    id="task-table"
                    class="table table-hover text-center text-nowrap"
                >
                    <thead>
                      <tr>
                        <th></th>
                        <th>任务名</th>
                        <th>采集状态</th>
                        <th>操作</th>
                        <th>最近编辑时间</th>
                        <th>运行耗时</th>
                        <th>执行次数</th>
                        <th>采集完成时间</th>
                        <th>进度情况</th>
                        <th>更多操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr id="1">
                        <td>1</td>
                        <td>
                          <a
                            data-id="1"
                            href="#rename-task-modal"
                            data-toggle="modal"
                            data-target="#rename-task-modal"
                            ><i class="fas fa-pen hidden"></i>&nbsp;</a
                          >豆瓣电影1
                        </td>
                        <td class="ready">
                          等待运行
                        </td>
                        <td class="ready">
                          <a href="" data-toggle="modal" data-target="" data-id="1">
                            <i class="far fa-pause-circle hidden"></i>
                          </a>
                          <a
                            data-id="1"
                            href="#cancel-task-modal"
                            data-toggle="modal"
                            data-target="#cancel-task-modal"
                          >
                            <i class="far fa-stop-circle hidden"></i>
                          </a>
                        </td>
                        <td>20/04/22 12:00</td>
                        <td></td>
                        <td>1</td>
                        <td></td>
                        <td>
                          <div class="progress progress-xs" title="0%">
                            <div
                              class="progress-bar progress-bar-danger progress-bar-striped progress-bar-animated"
                              style="width: 0%;"
                            ></div>
                          </div>
                        </td>
                        <td>
                          <div class="dropdown">
                            <a
                              class="nav-link task-dropdown"
                              data-toggle="dropdown"
                              href="#"
                            >
                              <i class="fas fa-ellipsis-h"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                              <a class="dropdown-item" href="{% url 'template_setting' 1 %}?taskID=1">编辑</a>
                              <a class="dropdown-item" href="#">查看采集数据</a>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr id="2">
                        <td>2</td>
                        <td>
                          <a
                            data-id="2"
                            href="#rename-task-modal"
                            data-toggle="modal"
                            data-target="#rename-task-modal"
                            ><i class="fas fa-pen hidden"></i>&nbsp;</a
                          >豆瓣电影2
                        </td>
                        <td class="paused">
                          已暂停
                        </td>
                        <td class="paused">
                          <a href="" data-toggle="modal" data-target="" data-id="2">
                            <i class="far fa-play-circle hidden"></i>
                          </a>
                          <a
                            data-id="2"
                            href="#cancel-task-modal"
                            data-toggle="modal"
                            data-target="#cancel-task-modal"
                          >
                            <i class="far fa-stop-circle hidden"></i>
                          </a>
                        </td>
                        <td>20/04/22 13:00</td>
                        <td></td>
                        <td>1</td>
                        <td></td>
                        <td>
                          <div class="progress progress-xs" title="55%">
                            <div
                              class="progress-bar progress-bar-danger progress-bar-striped progress-bar-animated"
                              style="width: 55%;"
                            ></div>
                          </div>
                        </td>
                        <td>
                          <div class="dropdown">
                            <a
                              class="nav-link task-dropdown"
                              data-toggle="dropdown"
                              href="#"
                            >
                              <i class="fas fa-ellipsis-h"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                              <a class="dropdown-item" href="{% url 'template_setting' 1 %}?taskID=2">编辑</a>
                              <a class="dropdown-item" href="#">查看采集数据</a>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr id="3">
                        <td>3</td>
                        <td>
                          <a
                            data-id="3"
                            href="#rename-task-modal"
                            data-toggle="modal"
                            data-target="#rename-task-modal"
                            ><i class="fas fa-pen hidden"></i>&nbsp;</a
                          >豆瓣电影3
                        </td>
                        <td class="running">
                          运行中
                        </td>
                        <td class="running">
                          <a href="" data-toggle="modal" data-target="">
                            <i class="far fa-pause-circle hidden"></i>
                          </a>
                          <a
                            data-id="3"
                            href="#cancel-task-modal"
                            data-toggle="modal"
                            data-target="#cancel-task-modal"
                          >
                            <i class="far fa-stop-circle hidden"></i>
                          </a>
                        </td>
                        <td>20/04/22 14:00</td>
                        <td></td>
                        <td>1</td>
                        <td></td>
                        <td>
                          <div class="progress progress-xs" title="55%">
                            <div
                              class="progress-bar progress-bar-danger progress-bar-striped progress-bar-animated"
                              style="width: 55%;"
                            ></div>
                          </div>
                        </td>
                        <td>
                          <div class="dropdown">
                            <a
                              class="nav-link task-dropdown"
                              data-toggle="dropdown"
                              href="#"
                            >
                              <i class="fas fa-ellipsis-h"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                              <a class="dropdown-item" href="{% url 'template_setting' 1 %}?taskID=3">编辑</a>
                              <a class="dropdown-item" href="#">查看采集数据</a>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr id="4">
                        <td>4</td>
                        <td>
                          <a
                            data-id="4"
                            href="#rename-task-modal"
                            data-toggle="modal"
                            data-target="#rename-task-modal"
                            ><i class="fas fa-pen hidden"></i>&nbsp;</a
                          >豆瓣电影4
                        </td>
                        <td class="finished">
                          已完成
                        </td>
                        <td class="finished">
                          <a
                            data-id="4"
                            href="#restart-task-modal"
                            data-toggle="modal"
                            data-target="#restart-task-modal"
                          >
                            <i class="far fa-play-circle hidden"></i>
                          </a>
                        </td>
                        <td>20/04/22 15:00</td>
                        <td></td>
                        <td>1</td>
                        <td></td>
                        <td>
                          <div class="progress progress-xs" title="55%">
                            <div
                              class="progress-bar progress-bar-danger progress-bar-striped progress-bar-animated"
                              style="width: 55%;"
                            ></div>
                          </div>
                        </td>
                        <td>
                          <div class="dropdown">
                            <a
                              class="nav-link task-dropdown"
                              data-toggle="dropdown"
                              href="#"
                            >
                              <i class="fas fa-ellipsis-h"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                              <a class="dropdown-item" href="{% url 'template_setting' 1 %}?taskID=4">编辑</a>
                              <a class="dropdown-item" href="#">查看采集数据</a>
                            </div>
                          </div>
                        </td>
                      </tr>
                      <tr id="5">
                        <td>5</td>
                        <td>
                          <a
                            data-id="5"
                            href="#rename-task-modal"
                            data-toggle="modal"
                            data-target="#rename-task-modal"
                            ><i class="fas fa-pen hidden"></i>&nbsp;</a
                          >豆瓣电影5
                        </td>
                        <td class="canceled">
                          已终止
                        </td>
                        <td class="canceled">
                          <a
                            data-id="5"
                            href="#restart-task-modal"
                            data-toggle="modal"
                            data-target="#restart-task-modal"
                          >
                            <i class="far fa-play-circle hidden"></i>
                          </a>
                        </td>
                        <td>20/04/22 16:00</td>
                        <td></td>
                        <td>1</td>
                        <td></td>
                        <td>
                          <div class="progress progress-xs" title="55%">
                            <div
                              class="progress-bar progress-bar-danger progress-bar-striped progress-bar-animated"
                              style="width: 55%;"
                            ></div>
                          </div>
                        </td>
                        <td>
                          <div class="dropdown">
                            <a
                              class="nav-link task-dropdown"
                              data-toggle="dropdown"
                              href="#"
                            >
                              <i class="fas fa-ellipsis-h"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                              <a class="dropdown-item" href="{% url 'template_setting' 1 %}?taskID=5">编辑</a>
                              <a class="dropdown-item" href="#">查看采集数据</a>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                </table>
            </form>
        </div>
      </div>
    </div>
{% endblock %}

{% block modal %}
    <div class="modal fade" id="cancel-task-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{% url 'my_task' %}" method="POST" id="cancel-task-form">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="card-comments">
                            <div class="card-comment">
                              <img
                                class="img-circle img-sm"
                                src="{% static 'img/warning.JPG' %}"
                                alt="warning"
                              />
                              <div class="comment-text">
                                <h5 class="username">确定</h5>
                                <!-- /.username -->
                                确定要终止吗？
                              </div>
                              <!-- /.comment-text -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                      <button
                        type="button"
                        class="btn btn-default"
                        data-dismiss="modal"
                      >
                        取消
                      </button>
                      <button type="submit" class="btn btn-primary">
                        确定
                      </button>
                </div>
                </form>
            </div>
            <!-- /.modal-content -->
            </div>
        <!-- /.modal-dialog -->
    </div>
    <div class="modal fade" id="restart-task-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="restart-task-form" action="{% url 'my_task' %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                      <div class="card-comments">
                        <div class="card-comment">
                          <img
                            class="img-circle img-sm"
                            src="{% static 'img/warning.JPG' %}"
                            alt="warning"
                          />
                          <div class="comment-text">
                            <h5 class="username">确定</h5>
                            <!-- /.username -->
                            原有采集数据会被覆盖，确定要重新开始吗？
                          </div>
                          <!-- /.comment-text -->
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                      <button
                        type="button"
                        class="btn btn-default"
                        data-dismiss="modal"
                      >
                        取消
                      </button>
                      <button type="submit" class="btn btn-primary">
                        确定
                      </button>
                    </div>
                </form>
            </div>
        <!-- /.modal-content -->
        </div>
    <!-- /.modal-dialog -->
    </div>
    <div class="modal fade" id="rename-task-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">修改任务名</h4>
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form id="rename-task-form" action="{% url 'my_task' %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="col-form-label" for="task-name-input"
                              >任务名：</label
                            >
                            <input
                              type="text"
                              class="form-control"
                              id="task-name-input"
                              placeholder="请输入新任务名..."
                            />
                        </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                      <button
                        type="button"
                        class="btn btn-default"
                        data-dismiss="modal"
                      >
                        取消
                      </button>
                      <button type="submit" class="btn btn-primary">
                        确定
                      </button>
                    </div>
                </form>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
{% endblock %}

{% block js_extend %}
    <!-- DataTables -->
    <script
        type="text/javascript"
        src="https://cdn.datatables.net/v/bs4/dt-1.10.20/cr-1.5.2/r-2.2.3/datatables.min.js"
    ></script>
    <!-- DataTable Checkbox -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-datatables-checkboxes@1.2.11/js/dataTables.checkboxes.min.js"></script>
    <!-- Custom JS -->
    <script src="{% static 'task/js/task.js' %}"></script>
    <script>
        let userID = {{ user.pk }};

        let taskSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/task/' + userID + '/');

        taskSocket.onmessage = function(e) {
            let data = JSON.parse(e.data);
            let message = data['message'];
            let taskID = message["task_id"];
            let status = "";
            if("status" in message) {
                status = message["status"];
            }
            let statusDisplayName = "";
            if("status_display_name" in message) {
                statusDisplayName = message["status_display_name"];
            }
            let progress = message["progress"];
            let duration = "";
            if("duration" in message) {
                duration = message["duration"];
            }
            let finishTime = "";
            if("finish_time" in message) {
                finishTime = message["finish_time"];
            }
            let tdEles = $("tr#" + taskID + " td");
            // 修改状态
            if(status !== "") {
                tdEles.eq(2).html(statusDisplayName).removeClass().addClass(status);
            }
            let ops = tdEles.eq(3);
            if(status !== "") {
                // 修改操作
                ops.removeClass().addClass(status);
            }
            if (status === "finished") {
                ops.empty();
                ops.append("                          <a\n" +
                    "                            data-id=\"" + taskID + "\"\n" +
                    "                            href=\"#restart-task-modal\"\n" +
                    "                            data-toggle=\"modal\"\n" +
                    "                            data-target=\"#restart-task-modal\"\n" +
                    "                          >\n" +
                    "                            <i class=\"far fa-play-circle hidden\"></i>\n" +
                    "                          </a>");
            }
            tdEles.eq(8).find(".progress")
                       .attr("title", progress)
                       .find(".progress-bar")
                       .css("width", progress);
            if(duration !== "") {
                tdEles.eq(5).html(duration);
            }
            if(finishTime !== "") {
                tdEles.eq(7).html(finishTime);
            }
            taskTable.columns.adjust().draw();
        };

        taskSocket.onclose = function(e) {
            console.error('Task socket closed unexpectedly');
        };
    </script>
    <script>
        taskTableBodyEle.find("tr td:nth-of-type(4) a").on("click", function () {
            let ele = $(this).find("i");
            let parent = $(this).parent("td");
            let status = parent.prev("td");
            let taskID = $(this).attr("data-id");
            let url = $("task-form").attr("action");
            let post_data = {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'id': taskID
            };
            if(ele.hasClass("fa-pause-circle")) {
                ele.attr("class", "far fa-play-circle hidden");
                parent.removeClass();
                parent.addClass("paused");
                status.removeClass();
                status.addClass("paused");
                status.html("已暂停");
                post_data["for"] = "pauseTask";
                $.ajax({
                    url: url,
                    type: "POST",
                    data: post_data,
                    cache: false,
                    success: function (data) {
                      if(data["status"] === "SUCCESS") {
                          Toast.fire({
                              icon: "success",
                              title: "&nbsp;任务已暂停",
                          });
                      } else {
                          Toast.fire({
                              icon: "error",
                              title: "&nbsp;" + data["message"],
                          });
                      }
                    },
                    error: function (xhr) {
                      console.log(xhr);
                    }
                });
            } else if(ele.hasClass("fa-play-circle")) {
                let statusText = status.text().trim();
                if(statusText !== "已完成" && statusText !== "已终止") {
                    // 进度条为0则置为等待运行，否则置为运行中
                    let progress = parent.nextAll("td").eq(4).find(".progress").attr("title");
                    ele.attr("class", "far fa-pause-circle hidden");
                    parent.removeClass();
                    status.removeClass();
                    if(progress === "0%") {
                        parent.addClass("ready");
                        status.addClass("ready");
                        status.html("等待运行");
                        post_data["for"] = "readyTask";
                        $.ajax({
                            url: url,
                            type: "POST",
                            data: post_data,
                            cache: false,
                            success: function (data) {
                              if(data["status"] === "SUCCESS") {
                                  Toast.fire({
                                      icon: "success",
                                      title: "&nbsp;任务正在排队",
                                  });
                              } else {
                                  Toast.fire({
                                      icon: "error",
                                      title: "&nbsp;" + data["message"],
                                  });
                              }
                            },
                            error: function (xhr) {
                              console.log(xhr);
                            }
                        });
                    } else {
                        parent.addClass("running");
                        status.addClass("running");
                        status.html("运行中");
                        post_data["for"] = "runningTask";
                        $.ajax({
                            url: url,
                            type: "POST",
                            data: post_data,
                            cache: false,
                            success: function (data) {
                              if(data["status"] === "SUCCESS") {
                                  Toast.fire({
                                      icon: "success",
                                      title: "&nbsp;任务将从暂停位置开始继续运行",
                                  });
                              } else {
                                  Toast.fire({
                                      icon: "error",
                                      title: "&nbsp;" + data["message"],
                                  });
                              }
                            },
                            error: function (xhr) {
                              console.log(xhr);
                            }
                        });
                    }
                }
            }
            taskTable.columns.adjust().draw();
        });
    </script>
{% endblock %}
